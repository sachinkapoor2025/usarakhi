  name: Deploy Usa Rakhi

  on:
    push:
      branches: [ main, develop, 'feature/*' ]
    pull_request:
      branches: [ main, develop, 'feature/*' ]

  env:
    AWS_REGION: us-east-1
    SAM_CLI_TELEMETRY: 0

  jobs:
    # test:
    #   runs-on: ubuntu-latest
    #   
    #   steps:
    #   - name: Checkout code
    #     uses: actions/checkout@v4
    #
    #   - name: Setup Node.js
    #     uses: actions/setup-node@v4
    #     with:
    #       node-version: '20'
    #       cache: 'npm'
    #
    #   - name: Install frontend dependencies
    #     run: |
    #       cd frontend
    #       npm install --no-audit --no-fund
    #
    #   - name: Run frontend tests
    #     run: |
    #       cd frontend
    #       npm test -- --watchAll=false --passWithNoTests
    #
    #   - name: Run frontend linting
    #     run: |
    #       cd frontend
    #       npm run lint
    #
    #   - name: Install backend dependencies
    #     run: |
    #       cd backend
    #       npm ci
    #
    #   - name: Run backend tests 
    #     run: |
    #       cd backend
    #       npm test
    #
    #   - name: Run backend linting
    #     run: |
    #       cd backend
    #       npm run lint

    build-and-deploy:
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/')
      
      steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup AWS SAM
        uses: aws-actions/setup-sam@v2

      - name: Build backend
        run: |
          cd backend
          npm install --no-audit --no-fund
          npm run build

      # - name: Deploy backend infrastructure
      #   run: |
      #     cd infrastructure
      #     sam build --template template.yaml
      #     STAGE_NAME=$(echo ${{ github.ref_name }} | tr '/' '-')
      #     sam deploy \
      #       --stack-name usa-rakhi-dev-1 \
      #       --parameter-overrides \
      #         Stage=$STAGE_NAME \ 
      #         StripeSecretKey=dummy-stripe-key \
      #         CognitoUserPoolId=dummy-user-pool-id \
      #         CognitoClientId=dummy-client-id \
      #         FrontendUrl=https://www.usarakhi.com \
      #         OpenAIAPIKey=sk-sample-openai-key-for-testing \
      #       --capabilities CAPABILITY_IAM \
      #       --resolve-s3 \
      #       --no-fail-on-empty-changeset

      - name: Build frontend
        run: |
          cd frontend
          npm install --no-audit --no-fund
          npm run build

      - name: Deploy frontend infrastructure to AWS
        id: deploy-frontend
        run: |
          STAGE_NAME=dev
          
          echo "üöÄ Deploying frontend infrastructure..."
          
          # Deploy the stack (this will create the ECR repository)
          aws cloudformation create-stack \
            --stack-name usa-rakhi-frontend \
            --template-body file://infrastructure/frontend-template.yaml \
            --parameters \
              ParameterKey=Stage,ParameterValue=$STAGE_NAME \
              ParameterKey=FrontendDomain,ParameterValue=usarakhi.com \
              ParameterKey=StripePublishableKey,ParameterValue=pk_test_dummy_key \
              ParameterKey=CognitoUserPoolId,ParameterValue=dummy-user-pool-id \
              ParameterKey=CognitoClientId,ParameterValue=dummy-client-id \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }} \
            || aws cloudformation update-stack \
            --stack-name usa-rakhi-frontend \
            --template-body file://infrastructure/frontend-template.yaml \
            --parameters \
              ParameterKey=Stage,ParameterValue=$STAGE_NAME \
              ParameterKey=FrontendDomain,ParameterValue=usarakhi.com \
              ParameterKey=StripePublishableKey,ParameterValue=pk_test_dummy_key \
              ParameterKey=CognitoUserPoolId,ParameterValue=dummy-user-pool-id \
              ParameterKey=CognitoClientId,ParameterValue=dummy-client-id \
            --capabilities CAPABILITY_NAMED_IAM \
            --region ${{ env.AWS_REGION }}
          
          echo "‚è≥ Waiting for stack deployment to complete..."
          
          # Wait for deployment to complete
          aws cloudformation wait stack-create-complete \
            --stack-name usa-rakhi-frontend \
            --region ${{ env.AWS_REGION }} \
            || aws cloudformation wait stack-update-complete \
            --stack-name usa-rakhi-frontend \
            --region ${{ env.AWS_REGION }}
          
          echo "‚úÖ Stack deployment completed successfully!"
          
          # Get stack outputs (including ECR repository URL)
          STACK_OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name usa-rakhi-frontend \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs' --output json)
          
          FRONTEND_URL=$(echo $STACK_OUTPUTS | jq -r '.[] | select(.OutputKey==\"FrontendUrl\") | .OutputValue')
          LAMBDA_FUNCTION_ARN=$(echo $STACK_OUTPUTS | jq -r '.[] | select(.OutputKey==\"NextJsLambdaFunction\") | .OutputValue')
          CLOUDFRONT_ID=$(echo $STACK_OUTPUTS | jq -r '.[] | select(.OutputKey==\"CloudFrontDistributionId\") | .OutputValue')
          ECR_REPOSITORY_URL=$(echo $STACK_OUTPUTS | jq -r '.[] | select(.OutputKey==\"FrontendECRRepository\") | .OutputValue')
          
          echo "FRONTEND_URL=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "LAMBDA_FUNCTION_ARN=$LAMBDA_FUNCTION_ARN" >> $GITHUB_OUTPUT
          echo "CLOUDFRONT_ID=$CLOUDFRONT_ID" >> $GITHUB_OUTPUT
          echo "ECR_REPOSITORY_URL=$ECR_REPOSITORY_URL" >> $GITHUB_OUTPUT
          
          echo "üåê Frontend URL: $FRONTEND_URL"
          echo "‚ö° Lambda Function ARN: $LAMBDA_FUNCTION_ARN"
          echo "‚òÅÔ∏è CloudFront Distribution ID: $CLOUDFRONT_ID"
          echo "üì¶ ECR Repository URL: $ECR_REPOSITORY_URL"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: private

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REPOSITORY_URL: ${{ steps.deploy-frontend.outputs.ECR_REPOSITORY_URL }}
          IMAGE_TAG: latest
        run: |
          echo "üèóÔ∏è Building Docker image..."
          docker build -t $ECR_REPOSITORY_URL:$IMAGE_TAG frontend/
          
          echo "üì§ Pushing image to ECR..."
          docker push $ECR_REPOSITORY_URL:$IMAGE_TAG
          
          echo "‚úÖ Image pushed successfully to $ECR_REPOSITORY_URL:$IMAGE_TAG"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.deploy-frontend.outputs.CLOUDFRONT_ID }} \
            --paths "/*" \
            --region ${{ env.AWS_REGION }}

      - name: Notify frontend deployment
        run: |
          echo "‚úÖ Frontend deployed successfully!"
          echo "üåê Frontend URL: ${{ steps.deploy-frontend.outputs.FRONTEND_URL }}"

      - name: Notify deployment
        run: |
          echo "‚úÖ Deployment finished successfully"

    deploy-staging:
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/')
      
      steps:
      - name: Notify staging deployment
        run: |
          echo "üöÄ Deploying to staging environment..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"

    deploy-feature:
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/heads/feature/')
      
      steps:
      - name: Notify feature deployment
        run: |
          echo "üöÄ Deploying to feature environment..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"

    deploy-production:
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/main'
      environment: production
      
      steps:
      - name: Notify production deployment
        run: |
          echo "üöÄ Deploying to production environment..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"

    # security-scan:
    #   runs-on: ubuntu-latest
    #   if: github.event_name == 'pull_request'
    #   
    #   steps:
    #   - name: Checkout code 
    #     uses: actions/checkout@v4
    #
    #   - name: Run Trivy vulnerability scanner
    #     uses: aquasecurity/trivy-action@master
    #     with:
    #       scan-type: 'fs'
    #       scan-ref: '.'
    #       format: 'sarif'
    #       output: 'trivy-results.sarif'
    #
    #   - name: Upload Trivy scan results to GitHub Security tab
    #     uses: github/codeql-action/upload-sarif@v2
    #     if: always()
    #     with:
    #       sarif_file: 'trivy-results.sarif'
    #
    # performance-test:
    #   runs-on: ubuntu-latest
    #   if: github.ref == 'refs/heads/main'
    #   
    #   steps:
    #   - name: Checkout code
    #     uses: actions/checkout@v4
    #
    #   - name: Setup Node.js
    #     uses: actions/setup-node@v4
    #     with:
    #       node-version: '20'
    #
    #   - name: Install Lighthouse CI
    #     run: npm install -g @lhci/cli@0.12.x
    #
    #   - name: Run Lighthouse CI
    #     run: |
    #       cd frontend
    #       npm install --no-audit --no-fund
    #       npm run build
    #       lhci autorun
    #     env:
    #       LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
